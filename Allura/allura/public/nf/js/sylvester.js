// === Sylvester ===
// Vector and Matrix mathematics modules for JavaScript
// Copyright (c) 2007 James Coglan
// 
// Permission is hereby granted, free of charge, to any person obtaining
// a copy of this software and associated documentation files (the "Software"),
// to deal in the Software without restriction, including without limitation
// the rights to use, copy, modify, merge, publish, distribute, sublicense,
// and/or sell copies of the Software, and to permit persons to whom the
// Software is furnished to do so, subject to the following conditions:
// 
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
// 
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
// THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
// FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
// DEALINGS IN THE SOFTWARE.
var Sylvester={version:"0.1.3",precision:1e-6};function Vector(){}function Matrix(){}function Line(){}function Plane(){}Vector.prototype={e:function(e){return e<1||e>this.elements.length?null:this.elements[e-1]},dimensions:function(){return this.elements.length},modulus:function(){return Math.sqrt(this.dot(this))},eql:function(e){var t=this.elements.length,n=e.elements||e;if(t!=n.length)return!1;do{if(Math.abs(this.elements[t-1]-n[t-1])>Sylvester.precision)return!1}while(--t);return!0},dup:function(){return Vector.create(this.elements)},map:function(n){var r=[];return this.each(function(e,t){r.push(n(e,t))}),Vector.create(r)},each:function(e){for(var t,n=this.elements.length,r=n;t=r-n,e(this.elements[t],1+t),--n;);},toUnitVector:function(){var t=this.modulus();return 0===t?this.dup():this.map(function(e){return e/t})},angleFrom:function(e){var n=e.elements||e,e=this.elements.length;if(e!=n.length)return null;var r=0,i=0,s=0;if(this.each(function(e,t){r+=e*n[t-1],i+=e*e,s+=n[t-1]*n[t-1]}),i=Math.sqrt(i),s=Math.sqrt(s),i*s==0)return null;e=r/(i*s);return e<-1&&(e=-1),1<e&&(e=1),Math.acos(e)},isParallelTo:function(e){e=this.angleFrom(e);return null===e?null:e<=Sylvester.precision},isAntiparallelTo:function(e){e=this.angleFrom(e);return null===e?null:Math.abs(e-Math.PI)<=Sylvester.precision},isPerpendicularTo:function(e){e=this.dot(e);return null===e?null:Math.abs(e)<=Sylvester.precision},add:function(e){var n=e.elements||e;return this.elements.length!=n.length?null:this.map(function(e,t){return e+n[t-1]})},subtract:function(e){var n=e.elements||e;return this.elements.length!=n.length?null:this.map(function(e,t){return e-n[t-1]})},multiply:function(t){return this.map(function(e){return e*t})},x:function(e){return this.multiply(e)},dot:function(e){var t=e.elements||e,n=0,r=this.elements.length;if(r!=t.length)return null;for(;n+=this.elements[r-1]*t[r-1],--r;);return n},cross:function(e){var t=e.elements||e;if(3!=this.elements.length||3!=t.length)return null;e=this.elements;return Vector.create([e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]])},max:function(){for(var e,t=0,n=this.elements.length,r=n;e=r-n,Math.abs(this.elements[e])>Math.abs(t)&&(t=this.elements[e]),--n;);return t},indexOf:function(e){for(var t,n=null,r=this.elements.length,i=r;t=i-r,null===n&&this.elements[t]==e&&(n=1+t),--r;);return n},toDiagonalMatrix:function(){return Matrix.Diagonal(this.elements)},round:function(){return this.map(function(e){return Math.round(e)})},snapTo:function(t){return this.map(function(e){return Math.abs(e-t)<=Sylvester.precision?t:e})},distanceFrom:function(e){if(e.anchor)return e.distanceFrom(this);var n=e.elements||e;if(n.length!=this.elements.length)return null;var r,i=0;return this.each(function(e,t){r=e-n[t-1],i+=r*r}),Math.sqrt(i)},liesOn:function(e){return e.contains(this)},liesIn:function(e){return e.contains(this)},rotate:function(e,t){switch(this.elements.length){case 2:return 2!=(l=t.elements||t).length?null:(r=Matrix.Rotation(e).elements,i=this.elements[0]-l[0],s=this.elements[1]-l[1],Vector.create([l[0]+r[0][0]*i+r[0][1]*s,l[1]+r[1][0]*i+r[1][1]*s]));case 3:if(!t.direction)return null;var n=t.pointClosestTo(this).elements,r=Matrix.Rotation(e,t.direction).elements,i=this.elements[0]-n[0],s=this.elements[1]-n[1],l=this.elements[2]-n[2];return Vector.create([n[0]+r[0][0]*i+r[0][1]*s+r[0][2]*l,n[1]+r[1][0]*i+r[1][1]*s+r[1][2]*l,n[2]+r[2][0]*i+r[2][1]*s+r[2][2]*l]);default:return null}},reflectionIn:function(e){if(e.anchor){var t=this.elements.slice(),n=e.pointClosestTo(t).elements;return Vector.create([n[0]+(n[0]-t[0]),n[1]+(n[1]-t[1]),n[2]+(n[2]-(t[2]||0))])}var r=e.elements||e;return this.elements.length!=r.length?null:this.map(function(e,t){return r[t-1]+(r[t-1]-e)})},to3D:function(){var e=this.dup();switch(e.elements.length){case 3:break;case 2:e.elements.push(0);break;default:return null}return e},inspect:function(){return"["+this.elements.join(", ")+"]"},setElements:function(e){return this.elements=(e.elements||e).slice(),this}},Vector.create=function(e){return(new Vector).setElements(e)},Vector.i=Vector.create([1,0,0]),Vector.j=Vector.create([0,1,0]),Vector.k=Vector.create([0,0,1]),Vector.Random=function(e){for(var t=[];t.push(Math.random()),--e;);return Vector.create(t)},Vector.Zero=function(e){for(var t=[];t.push(0),--e;);return Vector.create(t)},Matrix.prototype={e:function(e,t){return e<1||e>this.elements.length||t<1||t>this.elements[0].length?null:this.elements[e-1][t-1]},row:function(e){return e>this.elements.length?null:Vector.create(this.elements[e-1])},col:function(e){if(e>this.elements[0].length)return null;for(var t,n=[],r=this.elements.length,i=r;t=i-r,n.push(this.elements[t][e-1]),--r;);return Vector.create(n)},dimensions:function(){return{rows:this.elements.length,cols:this.elements[0].length}},rows:function(){return this.elements.length},cols:function(){return this.elements[0].length},eql:function(e){var t=e.elements||e;if(void 0===t[0][0]&&(t=Matrix.create(t).elements),this.elements.length!=t.length||this.elements[0].length!=t[0].length)return!1;var n,r,i,s=this.elements.length,l=s,o=this.elements[0].length;do{n=l-s,r=o;do{if(i=o-r,Math.abs(this.elements[n][i]-t[n][i])>Sylvester.precision)return!1}while(--r)}while(--s);return!0},dup:function(){return Matrix.create(this.elements)},map:function(e){var t,n,r,i=[],s=this.elements.length,l=s,o=this.elements[0].length;do{for(t=l-s,n=o,i[t]=[];r=o-n,i[t][r]=e(this.elements[t][r],1+t,1+r),--n;);}while(--s);return Matrix.create(i)},isSameSizeAs:function(e){e=e.elements||e;return void 0===e[0][0]&&(e=Matrix.create(e).elements),this.elements.length==e.length&&this.elements[0].length==e[0].length},add:function(e){var r=e.elements||e;return void 0===r[0][0]&&(r=Matrix.create(r).elements),this.isSameSizeAs(r)?this.map(function(e,t,n){return e+r[t-1][n-1]}):null},subtract:function(e){var r=e.elements||e;return void 0===r[0][0]&&(r=Matrix.create(r).elements),this.isSameSizeAs(r)?this.map(function(e,t,n){return e-r[t-1][n-1]}):null},canMultiplyFromLeft:function(e){e=e.elements||e;return void 0===e[0][0]&&(e=Matrix.create(e).elements),this.elements[0].length==e.length},multiply:function(t){if(!t.elements)return this.map(function(e){return e*t});var e=!!t.modulus;if(void 0===(f=t.elements||t)[0][0]&&(f=Matrix.create(f).elements),!this.canMultiplyFromLeft(f))return null;var n,r,i,s,l,o,a=this.elements.length,h=a,c=f[0].length,u=this.elements[0].length,m=[];do{m[n=h-a]=[],r=c;do{for(i=c-r,s=0,l=u;o=u-l,s+=this.elements[n][o]*f[o][i],--l;);}while(m[n][i]=s,--r)}while(--a);var f=Matrix.create(m);return e?f.col(1):f},x:function(e){return this.multiply(e)},minor:function(e,t,n,r){var i,s,l,o=[],a=n,h=this.elements.length,c=this.elements[0].length;do{for(i=n-a,o[i]=[],s=r;l=r-s,o[i][l]=this.elements[(e+i-1)%h][(t+l-1)%c],--s;);}while(--a);return Matrix.create(o)},transpose:function(){var e,t,n,r=this.elements.length,i=this.elements[0].length,s=[],l=i;do{for(e=i-l,s[e]=[],t=r;n=r-t,s[e][n]=this.elements[n][e],--t;);}while(--l);return Matrix.create(s)},isSquare:function(){return this.elements.length==this.elements[0].length},max:function(){var e,t,n,r=0,i=this.elements.length,s=i,l=this.elements[0].length;do{for(e=s-i,t=l;n=l-t,Math.abs(this.elements[e][n])>Math.abs(r)&&(r=this.elements[e][n]),--t;);}while(--i);return r},indexOf:function(e){var t,n,r,i=this.elements.length,s=i,l=this.elements[0].length;do{t=s-i,n=l;do{if(r=l-n,this.elements[t][r]==e)return{i:1+t,j:1+r}}while(--n)}while(--i);return null},diagonal:function(){if(!this.isSquare)return null;for(var e,t=[],n=this.elements.length,r=n;e=r-n,t.push(this.elements[e][e]),--n;);return Vector.create(t)},toRightTriangular:function(){var e,t,n=this.dup(),r=this.elements.length,i=r,s=this.elements[0].length;do{if(e=i-r,0==n.elements[e][e])for(j=1+e;j<i;j++)if(0!=n.elements[j][e]){for(o=[],a=s;t=s-a,o.push(n.elements[e][t]+n.elements[j][t]),--a;);n.elements[e]=o;break}if(0!=n.elements[e][e])for(j=1+e;j<i;j++){for(var l=n.elements[j][e]/n.elements[e][e],o=[],a=s;t=s-a,o.push(t<=e?0:n.elements[j][t]-n.elements[e][t]*l),--a;);n.elements[j]=o}}while(--r);return n},toUpperTriangular:function(){return this.toRightTriangular()},determinant:function(){if(!this.isSquare())return null;for(var e,t=this.toRightTriangular(),n=t.elements[0][0],r=t.elements.length-1,i=r;e=i-r+1,n*=t.elements[e][e],--r;);return n},det:function(){return this.determinant()},isSingular:function(){return this.isSquare()&&0===this.determinant()},trace:function(){if(!this.isSquare())return null;for(var e,t=this.elements[0][0],n=this.elements.length-1,r=n;e=r-n+1,t+=this.elements[e][e],--n;);return t},tr:function(){return this.trace()},rank:function(){var e,t,n,r=this.toRightTriangular(),i=0,s=this.elements.length,l=s,o=this.elements[0].length;do{e=l-s,t=o;do{if(n=o-t,Math.abs(r.elements[e][n])>Sylvester.precision){i++;break}}while(--t)}while(--s);return i},rk:function(){return this.rank()},augment:function(e){var t=e.elements||e;void 0===t[0][0]&&(t=Matrix.create(t).elements);var n,r,i,s=this.dup(),l=s.elements[0].length,o=s.elements.length,a=o,h=t[0].length;if(o!=t.length)return null;do{for(n=a-o,r=h;i=h-r,s.elements[n][l+i]=t[n][i],--r;);}while(--o);return s},inverse:function(){if(!this.isSquare()||this.isSingular())return null;var e,t,n,r,i,s,l,o=this.elements.length,a=o,h=this.augment(Matrix.I(o)).toRightTriangular(),c=h.elements[0].length,u=[];do{for(e=o-1,i=[],n=c,u[e]=[],s=h.elements[e][e];r=c-n,l=h.elements[e][r]/s,i.push(l),a<=r&&u[e].push(l),--n;);for(h.elements[e]=i,t=0;t<e;t++){for(i=[],n=c;r=c-n,i.push(h.elements[t][r]-h.elements[e][r]*h.elements[t][e]),--n;);h.elements[t]=i}}while(--o);return Matrix.create(u)},inv:function(){return this.inverse()},round:function(){return this.map(function(e){return Math.round(e)})},snapTo:function(t){return this.map(function(e){return Math.abs(e-t)<=Sylvester.precision?t:e})},inspect:function(){for(var e,t=[],n=this.elements.length,r=n;e=r-n,t.push(Vector.create(this.elements[e]).inspect()),--n;);return t.join("\n")},setElements:function(e){var t,n=e.elements||e;if(void 0!==n[0][0]){var r,i,s,l=n.length,o=l;this.elements=[];do{for(t=o-l,r=n[t].length,i=r,this.elements[t]=[];s=i-r,this.elements[t][s]=n[t][s],--r;);}while(--l);return this}var a=n.length,h=a;for(this.elements=[];t=h-a,this.elements.push([n[t]]),--a;);return this}},Matrix.create=function(e){return(new Matrix).setElements(e)},Matrix.I=function(e){var t,n,r,i=[],s=e;do{for(t=s-e,i[t]=[],n=s;r=s-n,i[t][r]=t==r?1:0,--n;);}while(--e);return Matrix.create(i)},Matrix.Diagonal=function(e){for(var t,n=e.length,r=n,i=Matrix.I(n);t=r-n,i.elements[t][t]=e[t],--n;);return i},Matrix.Rotation=function(e,t){if(!t)return Matrix.create([[Math.cos(e),-Math.sin(e)],[Math.sin(e),Math.cos(e)]]);var n=t.dup();if(3!=n.elements.length)return null;var r=n.modulus(),i=n.elements[0]/r,s=n.elements[1]/r,t=n.elements[2]/r,n=Math.sin(e),r=Math.cos(e),e=1-r;return Matrix.create([[e*i*i+r,e*i*s-n*t,e*i*t+n*s],[e*i*s+n*t,e*s*s+r,e*s*t-n*i],[e*i*t-n*s,e*s*t+n*i,e*t*t+r]])},Matrix.RotationX=function(e){var t=Math.cos(e),e=Math.sin(e);return Matrix.create([[1,0,0],[0,t,-e],[0,e,t]])},Matrix.RotationY=function(e){var t=Math.cos(e),e=Math.sin(e);return Matrix.create([[t,0,e],[0,1,0],[-e,0,t]])},Matrix.RotationZ=function(e){var t=Math.cos(e),e=Math.sin(e);return Matrix.create([[t,-e,0],[e,t,0],[0,0,1]])},Matrix.Random=function(e,t){return Matrix.Zero(e,t).map(function(){return Math.random()})},Matrix.Zero=function(e,t){var n,r,i,s=[],l=e;do{for(n=e-l,s[n]=[],r=t;i=t-r,s[n][i]=0,--r;);}while(--l);return Matrix.create(s)},Line.prototype={eql:function(e){return this.isParallelTo(e)&&this.contains(e.anchor)},dup:function(){return Line.create(this.anchor,this.direction)},translate:function(e){e=e.elements||e;return Line.create([this.anchor.elements[0]+e[0],this.anchor.elements[1]+e[1],this.anchor.elements[2]+(e[2]||0)],this.direction)},isParallelTo:function(e){if(e.normal)return e.isParallelTo(this);e=this.direction.angleFrom(e.direction);return Math.abs(e)<=Sylvester.precision||Math.abs(e-Math.PI)<=Sylvester.precision},distanceFrom:function(e){if(e.normal)return e.distanceFrom(this);if(e.direction){if(this.isParallelTo(e))return this.distanceFrom(e.anchor);var t=this.direction.cross(e.direction).toUnitVector().elements,n=this.anchor.elements,r=e.anchor.elements;return Math.abs((n[0]-r[0])*t[0]+(n[1]-r[1])*t[1]+(n[2]-r[2])*t[2])}var i=e.elements||e,n=this.anchor.elements,r=this.direction.elements,t=i[0]-n[0],e=i[1]-n[1],i=(i[2]||0)-n[2],n=Math.sqrt(t*t+e*e+i*i);if(0===n)return 0;r=(t*r[0]+e*r[1]+i*r[2])/n,r=1-r*r;return Math.abs(n*Math.sqrt(r<0?0:r))},contains:function(e){e=this.distanceFrom(e);return null!==e&&e<=Sylvester.precision},liesIn:function(e){return e.contains(this)},intersects:function(e){return e.normal?e.intersects(this):!this.isParallelTo(e)&&this.distanceFrom(e)<=Sylvester.precision},intersectionWith:function(e){if(e.normal)return e.intersectionWith(this);if(!this.intersects(e))return null;var t=this.anchor.elements,n=this.direction.elements,r=e.anchor.elements,i=e.direction.elements,s=n[0],l=n[1],o=n[2],a=i[0],h=i[1],c=i[2],u=t[0]-r[0],e=t[1]-r[1],n=t[2]-r[2],i=a*a+h*h+c*c,r=s*a+l*h+o*c,r=((-s*u-l*e-o*n)*i/(s*s+l*l+o*o)+r*(a*u+h*e+c*n))/(i-r*r);return Vector.create([t[0]+r*s,t[1]+r*l,t[2]+r*o])},pointClosestTo:function(e){if(e.direction){if(this.intersects(e))return this.intersectionWith(e);if(this.isParallelTo(e))return null;var t=this.direction.elements,n=e.direction.elements,r=t[0],i=t[1],s=t[2],l=n[0],o=n[1],a=n[2],h=s*l-r*a,c=r*o-i*l,n=i*a-s*o,o=Vector.create([h*a-c*o,c*l-n*a,n*o-h*l]);return(l=Plane.create(e.anchor,o)).intersectionWith(this)}l=e.elements||e;if(this.contains(l))return Vector.create(l);o=this.anchor.elements,r=(t=this.direction.elements)[0],i=t[1],s=t[2],e=o[0],t=o[1],o=o[2],h=r*(l[1]-t)-i*(l[0]-e),c=i*((l[2]||0)-o)-s*(l[1]-t),n=s*(l[0]-e)-r*((l[2]||0)-o),i=Vector.create([i*h-s*n,s*c-r*h,r*n-i*c]),c=this.distanceFrom(l)/i.modulus();return Vector.create([l[0]+i.elements[0]*c,l[1]+i.elements[1]*c,(l[2]||0)+i.elements[2]*c])},rotate:function(e,t){void 0===t.direction&&(t=Line.create(t.to3D(),Vector.k));var n=Matrix.Rotation(e,t.direction).elements,r=t.pointClosestTo(this.anchor).elements,i=this.anchor.elements,s=this.direction.elements,l=r[0],o=r[1],e=r[2],t=i[0]-l,r=i[1]-o,i=i[2]-e;return Line.create([l+n[0][0]*t+n[0][1]*r+n[0][2]*i,o+n[1][0]*t+n[1][1]*r+n[1][2]*i,e+n[2][0]*t+n[2][1]*r+n[2][2]*i],[n[0][0]*s[0]+n[0][1]*s[1]+n[0][2]*s[2],n[1][0]*s[0]+n[1][1]*s[1]+n[1][2]*s[2],n[2][0]*s[0]+n[2][1]*s[1]+n[2][2]*s[2]])},reflectionIn:function(e){if(e.normal){var t=this.anchor.elements,n=this.direction.elements,r=t[0],i=t[1],s=t[2],l=n[0],o=n[1],t=n[2],n=this.anchor.reflectionIn(e).elements,l=r+l,o=i+o,s=s+t,t=e.pointClosestTo([l,o,s]).elements,s=[t[0]+(t[0]-l)-n[0],t[1]+(t[1]-o)-n[1],t[2]+(t[2]-s)-n[2]];return Line.create(n,s)}if(e.direction)return this.rotate(Math.PI,e);e=e.elements||e;return Line.create(this.anchor.reflectionIn([e[0],e[1],e[2]||0]),this.direction)},setVectors:function(e,t){if(e=Vector.create(e),t=Vector.create(t),2==e.elements.length&&e.elements.push(0),2==t.elements.length&&t.elements.push(0),3<e.elements.length||3<t.elements.length)return null;var n=t.modulus();return 0===n?null:(this.anchor=e,this.direction=Vector.create([t.elements[0]/n,t.elements[1]/n,t.elements[2]/n]),this)}},Line.create=function(e,t){return(new Line).setVectors(e,t)},Line.X=Line.create(Vector.Zero(3),Vector.i),Line.Y=Line.create(Vector.Zero(3),Vector.j),Line.Z=Line.create(Vector.Zero(3),Vector.k),Plane.prototype={eql:function(e){return this.contains(e.anchor)&&this.isParallelTo(e)},dup:function(){return Plane.create(this.anchor,this.normal)},translate:function(e){e=e.elements||e;return Plane.create([this.anchor.elements[0]+e[0],this.anchor.elements[1]+e[1],this.anchor.elements[2]+(e[2]||0)],this.normal)},isParallelTo:function(e){var t;return e.normal?(t=this.normal.angleFrom(e.normal),Math.abs(t)<=Sylvester.precision||Math.abs(Math.PI-t)<=Sylvester.precision):e.direction?this.normal.isPerpendicularTo(e.direction):null},isPerpendicularTo:function(e){e=this.normal.angleFrom(e.normal);return Math.abs(Math.PI/2-e)<=Sylvester.precision},distanceFrom:function(e){if(this.intersects(e)||this.contains(e))return 0;if(e.anchor){var t=this.anchor.elements,n=e.anchor.elements,r=this.normal.elements;return Math.abs((t[0]-n[0])*r[0]+(t[1]-n[1])*r[1]+(t[2]-n[2])*r[2])}e=e.elements||e,t=this.anchor.elements,r=this.normal.elements;return Math.abs((t[0]-e[0])*r[0]+(t[1]-e[1])*r[1]+(t[2]-(e[2]||0))*r[2])},contains:function(e){if(e.normal)return null;if(e.direction)return this.contains(e.anchor)&&this.contains(e.anchor.add(e.direction));var t=e.elements||e,n=this.anchor.elements,e=this.normal.elements;return Math.abs(e[0]*(n[0]-t[0])+e[1]*(n[1]-t[1])+e[2]*(n[2]-(t[2]||0)))<=Sylvester.precision},intersects:function(e){return void 0===e.direction&&void 0===e.normal?null:!this.isParallelTo(e)},intersectionWith:function(e){if(!this.intersects(e))return null;if(e.direction){var t=e.anchor.elements,n=e.direction.elements,r=this.anchor.elements,r=((i=this.normal.elements)[0]*(r[0]-t[0])+i[1]*(r[1]-t[1])+i[2]*(r[2]-t[2]))/(i[0]*n[0]+i[1]*n[1]+i[2]*n[2]);return Vector.create([t[0]+n[0]*r,t[1]+n[1]*r,t[2]+n[2]*r])}if(e.normal){for(var n=this.normal.cross(e.normal).toUnitVector(),i=this.normal.elements,t=this.anchor.elements,s=e.normal.elements,r=e.anchor.elements,l=Matrix.Zero(2,2),o=0;l.isSingular();)o++,l=Matrix.create([[i[o%3],i[(o+1)%3]],[s[o%3],s[(o+1)%3]]]);for(var e=l.inverse().elements,t=i[0]*t[0]+i[1]*t[1]+i[2]*t[2],r=s[0]*r[0]+s[1]*r[1]+s[2]*r[2],a=[e[0][0]*t+e[0][1]*r,e[1][0]*t+e[1][1]*r],h=[],c=1;c<=3;c++)h.push(o==c?0:a[(c+(5-o)%3)%3]);return Line.create(h,n)}},pointClosestTo:function(e){var t=e.elements||e,n=this.anchor.elements,e=this.normal.elements,n=(n[0]-t[0])*e[0]+(n[1]-t[1])*e[1]+(n[2]-(t[2]||0))*e[2];return Vector.create([t[0]+e[0]*n,t[1]+e[1]*n,(t[2]||0)+e[2]*n])},rotate:function(e,t){var n=Matrix.Rotation(e,t.direction).elements,r=t.pointClosestTo(this.anchor).elements,i=this.anchor.elements,s=this.normal.elements,l=r[0],o=r[1],e=r[2],t=i[0]-l,r=i[1]-o,i=i[2]-e;return Plane.create([l+n[0][0]*t+n[0][1]*r+n[0][2]*i,o+n[1][0]*t+n[1][1]*r+n[1][2]*i,e+n[2][0]*t+n[2][1]*r+n[2][2]*i],[n[0][0]*s[0]+n[0][1]*s[1]+n[0][2]*s[2],n[1][0]*s[0]+n[1][1]*s[1]+n[1][2]*s[2],n[2][0]*s[0]+n[2][1]*s[1]+n[2][2]*s[2]])},reflectionIn:function(e){if(e.normal){var t=this.anchor.elements,n=this.normal.elements,r=t[0],i=t[1],s=t[2],l=n[0],o=n[1],t=n[2],n=this.anchor.reflectionIn(e).elements,l=r+l,o=i+o,s=s+t,t=e.pointClosestTo([l,o,s]).elements,s=[t[0]+(t[0]-l)-n[0],t[1]+(t[1]-o)-n[1],t[2]+(t[2]-s)-n[2]];return Plane.create(n,s)}if(e.direction)return this.rotate(Math.PI,e);e=e.elements||e;return Plane.create(this.anchor.reflectionIn([e[0],e[1],e[2]||0]),this.normal)},setVectors:function(e,t,n){if(null===(e=(e=Vector.create(e)).to3D()))return null;if(null===(t=(t=Vector.create(t)).to3D()))return null;if(void 0===n)n=null;else if(null===(n=(n=Vector.create(n)).to3D()))return null;var r=e.elements[0],i=e.elements[1],s=e.elements[2],l=t.elements[0],o=t.elements[1],a=t.elements[2];if(null!==n){var h=n.elements[0],c=n.elements[1],n=n.elements[2];if(0===(h=(c=Vector.create([(o-i)*(n-s)-(a-s)*(c-i),(a-s)*(h-r)-(l-r)*(n-s),(l-r)*(c-i)-(o-i)*(h-r)])).modulus()))return null;c=Vector.create([c.elements[0]/h,c.elements[1]/h,c.elements[2]/h])}else{if(0===(h=Math.sqrt(l*l+o*o+a*a)))return null;c=Vector.create([t.elements[0]/h,t.elements[1]/h,t.elements[2]/h])}return this.anchor=e,this.normal=c,this}},Plane.create=function(e,t,n){return(new Plane).setVectors(e,t,n)},Plane.XY=Plane.create(Vector.Zero(3),Vector.k),Plane.YZ=Plane.create(Vector.Zero(3),Vector.i),Plane.ZX=Plane.create(Vector.Zero(3),Vector.j),Plane.YX=Plane.XY,Plane.ZY=Plane.YZ,Plane.XZ=Plane.ZX;var $V=Vector.create,$M=Matrix.create,$L=Line.create,$P=Plane.create;